name: Benchmark and Chart

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  benchmark:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: oven-sh/setup-bun@v1

      - run: bun install

      - run: |
          bunx jsvu --os=linux64 --engines=v8
          echo "${HOME}/.jsvu/bin" >> $GITHUB_PATH

      - run: sudo apt-get update && sudo apt-get install -y binaryen

      - run: ./run-bench.as.sh
      - run: ./run-bench.js.sh

      - run: |
          mkdir -p data
          bun ./scripts/build-chart01.ts
          bun ./scripts/build-chart02.ts

      - name: Commit Charts to docs branch
        run: |
          set -e
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          # Ensure the docs branch exists locally
          git fetch origin docs || true
          if git rev-parse --verify docs >/dev/null 2>&1; then
            git branch -D docs
          fi
          git checkout -b docs origin/docs || git checkout --orphan docs

          # Copy generated charts
          mkdir -p charts
          cp data/*.svg charts/

          git add charts/
          git commit -m "Update benchmark charts [skip ci]" || echo "No changes to commit"
          git push origin docs --force
